name: Kaggle Submission Workflow

on:
  push: 
    branches: [ "main" ]
    paths-ignore: [ "README.md" ]

jobs:     
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
    - name: Checking out Code
      uses: actions/checkout@v4

    - name: Setup up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip3 install uv
        pip3 install kaggle

    - name: Building the code and publish it to Kaggle ${{ matrix.python-version }}
      run: ./scripts/publish_kaggle.sh <<< $(git log -1 --pretty=%s)
      env:
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}

  download-wheels:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:

    - name: Checking out Code
      uses: actions/checkout@v4

    - name: Setup up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip3 install uv
        pip3 install kaggle

    - name: Export uv project to requirements.txt
      run: uv export --format requirements.txt -o requirements.txt

    - name: Initialize Kaggle Datasets
      run: | 
        mkdir ./wheels
        cp requirements.txt ./wheels/
        kaggle datasets init --path ./wheels
        sed -i 's/INSERT_[^"]*/jigsaw_wheels/g' ./wheels/dataset-metadata.json
        cat ./wheels/dataset-metadata.json
      env:
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}

    - name: Export Wheels into the folder
      run: pip3 download -r requirements.txt -d ./wheels

    - name: Push to Kaggle dataset
      run: |
        version=$(uv version --short)
        if kaggle datasets status ${{ secrets.KAGGLE_USERNAME }}/jigsaw_wheels; then
          kaggle datasets version -m "Version $version : $(git log -1 --pretty=%s)" --path ./wheels
        else
          kaggle datasets create --path ./wheels
        fi
      env:
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}